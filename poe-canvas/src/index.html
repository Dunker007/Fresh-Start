<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nexus Workspace</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Roboto+Mono:wght@400;500&family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.0/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
  <link rel="stylesheet" href="src/styles/main.css">
</head>

<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <div class="logo-icon"><i class="fas fa-cube"></i></div>
          <span>Nexus</span>
        </div>
      </div>

      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Main</div>
          <div class="nav-item active" data-view="dashboard">
            <i class="fas fa-th-large"></i>
            <span>Dashboard</span>
          </div>
          <div class="nav-item" data-view="files">
            <i class="fas fa-folder"></i>
            <span>File Manager</span>
          </div>
          <div class="nav-item" data-view="canvas">
            <i class="fas fa-object-group"></i>
            <span>Layout Planner</span>
          </div>
          <div class="nav-item" data-view="ai">
            <i class="fas fa-robot"></i>
            <span>AI Assistant</span>
            <span class="badge">New</span>
          </div>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Workspaces</div>
          <div class="workspace-list" id="workspaceList">
            <!-- Workspaces populated by JS -->
          </div>
          <div class="nav-item" id="addWorkspaceBtn" style="color: var(--accent-primary);">
            <i class="fas fa-plus"></i>
            <span>New Workspace</span>
          </div>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Quick Access</div>
          <a class="quick-link" href="https://drive.google.com" target="_blank" rel="noopener">
            <div class="quick-link-icon" style="background: rgba(251,188,4,0.15); color: #fbbc04;">
              <i class="fab fa-google-drive"></i>
            </div>
            <span style="font-size: 14px;">Google Drive</span>
          </a>
          <a class="quick-link" href="https://calendar.google.com" target="_blank" rel="noopener">
            <div class="quick-link-icon" style="background: rgba(66,133,244,0.15); color: #4285f4;">
              <i class="fas fa-calendar"></i>
            </div>
            <span style="font-size: 14px;">Calendar</span>
          </a>
          <a class="quick-link" href="https://docs.google.com" target="_blank" rel="noopener">
            <div class="quick-link-icon" style="background: rgba(66,133,244,0.15); color: #4285f4;">
              <i class="fas fa-file-alt"></i>
            </div>
            <span style="font-size: 14px;">Docs</span>
          </a>
          <a class="quick-link" href="https://mail.google.com" target="_blank" rel="noopener">
            <div class="quick-link-icon" style="background: rgba(234,67,53,0.15); color: #ea4335;">
              <i class="fas fa-envelope"></i>
            </div>
            <span style="font-size: 14px;">Gmail</span>
          </a>
        </div>
      </nav>

      <div class="sidebar-footer">
        <button class="btn-secondary" style="width: 100%;" id="exportBtn">
          <i class="fas fa-download"></i> Export Data
        </button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Header -->
      <header class="header">
        <button class="btn-icon" id="toggleSidebar">
          <i class="fas fa-bars"></i>
        </button>

        <div class="search-bar">
          <i class="fas fa-search"></i>
          <input type="text" placeholder="Search everything..." id="globalSearch">
        </div>

        <div class="dropdown" id="settingsDropdown">
          <button class="btn-icon">
            <i class="fas fa-cog"></i>
          </button>
          <div class="dropdown-menu">
            <div class="dropdown-item" id="toggleTheme">
              <i class="fas fa-moon"></i>
              <span>Toggle Theme</span>
            </div>
            <div class="dropdown-item" id="importBtn">
              <i class="fas fa-upload"></i>
              <span>Import Data</span>
            </div>
            <div class="dropdown-divider"></div>
            <div class="dropdown-item" id="resetBtn">
              <i class="fas fa-trash"></i>
              <span>Reset All Data</span>
            </div>
          </div>
        </div>

        <input type="file" id="importInput" accept=".json" style="display: none;">
      </header>

      <!-- Dashboard View -->
      <div class="workspace-area" id="dashboardView">
        <!-- Tasks Widget -->
        <div class="widget" id="tasksWidget">
          <div class="widget-header">
            <div class="widget-title">
              <i class="fas fa-check-circle"></i>
              Tasks
            </div>
            <button class="btn-icon" id="addTaskBtn">
              <i class="fas fa-plus"></i>
            </button>
          </div>
          <div class="widget-content" id="taskList">
            <!-- Tasks populated by JS -->
          </div>
        </div>

        <!-- Timer Widget -->
        <div class="widget">
          <div class="widget-header">
            <div class="widget-title">
              <i class="fas fa-clock"></i>
              Focus Timer
            </div>
          </div>
          <div class="widget-content" style="text-align: center; padding: 24px;">
            <div class="timer-type-btns">
              <button class="timer-type-btn active" data-time="1500">Focus</button>
              <button class="timer-type-btn" data-time="300">Short Break</button>
              <button class="timer-type-btn" data-time="900">Long Break</button>
            </div>
            <div class="timer-display" id="timerDisplay">25:00</div>
            <div class="timer-controls">
              <button class="btn-primary" id="timerStartBtn">
                <i class="fas fa-play"></i> Start
              </button>
              <button class="btn-secondary" id="timerResetBtn">
                <i class="fas fa-undo"></i> Reset
              </button>
            </div>
          </div>
        </div>

        <!-- Notes Widget -->
        <div class="widget" id="notesWidget">
          <div class="widget-header">
            <div class="widget-title">
              <i class="fas fa-sticky-note"></i>
              Quick Notes
            </div>
            <button class="btn-icon" id="addNoteBtn">
              <i class="fas fa-plus"></i>
            </button>
          </div>
          <div class="widget-content" id="notesList">
            <!-- Notes populated by JS -->
          </div>
        </div>

        <!-- Calendar Widget -->
        <div class="widget">
          <div class="widget-header">
            <div class="widget-title">
              <i class="fas fa-calendar-alt"></i>
              <span id="calendarMonthYear"></span>
            </div>
            <div style="display: flex; gap: 4px;">
              <button class="btn-icon" id="prevMonth"><i class="fas fa-chevron-left"></i></button>
              <button class="btn-icon" id="nextMonth"><i class="fas fa-chevron-right"></i></button>
            </div>
          </div>
          <div class="widget-content">
            <div class="calendar-grid" id="calendarGrid">
              <!-- Calendar populated by JS -->
            </div>
          </div>
        </div>

        <!-- Projects Widget -->
        <div class="widget" id="projectsWidget">
          <div class="widget-header">
            <div class="widget-title">
              <i class="fas fa-project-diagram"></i>
              Projects
            </div>
            <button class="btn-icon" id="addProjectBtn">
              <i class="fas fa-plus"></i>
            </button>
          </div>
          <div class="widget-content" id="projectsList">
            <!-- Projects populated by JS -->
          </div>
        </div>

        <!-- Bookmarks Widget -->
        <div class="widget">
          <div class="widget-header">
            <div class="widget-title">
              <i class="fas fa-bookmark"></i>
              Bookmarks
            </div>
            <button class="btn-icon" id="addBookmarkBtn">
              <i class="fas fa-plus"></i>
            </button>
          </div>
          <div class="widget-content" id="bookmarksList">
            <!-- Bookmarks populated by JS -->
          </div>
        </div>
      </div>

      <!-- File Manager View -->
      <div class="workspace-area" id="filesView" style="display: none;">
        <div class="widget" style="grid-column: 1 / -1; max-height: none;">
          <div class="widget-header">
            <div class="widget-title">
              <i class="fas fa-folder-open"></i>
              <span id="currentPath">Files</span>
            </div>
            <div style="display: flex; gap: 8px;">
              <button class="btn-secondary" id="goDesktop" title="Desktop">
                <i class="fas fa-desktop"></i>
              </button>
              <button class="btn-secondary" id="goDocuments" title="Documents">
                <i class="fas fa-file-alt"></i>
              </button>
              <button class="btn-secondary" id="goDownloads" title="Downloads">
                <i class="fas fa-download"></i>
              </button>
              <button class="btn-icon" id="goUp" title="Up">
                <i class="fas fa-level-up-alt"></i>
              </button>
              <button class="btn-icon" id="refreshFiles" title="Refresh">
                <i class="fas fa-sync-alt"></i>
              </button>
            </div>
          </div>
          <div class="widget-content">
            <div id="bridgeStatus"
              style="padding: 8px 12px; margin-bottom: 12px; border-radius: var(--radius-sm); background: var(--bg-tertiary); font-size: 13px; display: none;">
              <i class="fas fa-info-circle"></i> <span id="bridgeStatusText"></span>
            </div>
            <div class="file-grid" id="fileGrid">
              <!-- Files populated by JS -->
            </div>
          </div>
        </div>
      </div>

      <!-- Layout Planner View -->
      <div class="workspace-area" id="canvasView" style="display: none;">
        <div class="widget" style="grid-column: 1 / -1; max-height: none;">
          <div class="widget-header">
            <div class="widget-title">
              <i class="fas fa-object-group"></i>
              Layout Planner
            </div>
            <div style="display: flex; gap: 8px;">
              <button class="btn-secondary" id="addLayoutItem">
                <i class="fas fa-plus"></i> Add Zone
              </button>
              <button class="btn-secondary" id="clearCanvas">
                <i class="fas fa-trash"></i> Clear
              </button>
              <button class="btn-primary" id="saveLayout">
                <i class="fas fa-save"></i> Save Layout
              </button>
            </div>
          </div>
          <div class="widget-content" style="padding: 0;">
            <div class="layout-canvas" id="layoutCanvas">
              <div class="layout-grid"></div>
              <!-- Layout items populated by JS -->
            </div>
          </div>
        </div>
      </div>

      <!-- AI Assistant View -->
      <div class="workspace-area" id="aiView" style="display: none;">
        <div class="widget"
          style="grid-column: 1 / -1; max-height: none; height: calc(100vh - 124px); display: flex; flex-direction: column;">
          <div class="widget-header">
            <div class="widget-title">
              <i class="fas fa-robot"></i>
              AI Assistant
            </div>
            <div style="display: flex; align-items: center; gap: 12px;">
              <div id="llmStatus"
                style="display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text-muted);">
                <span id="llmStatusDot"
                  style="width: 8px; height: 8px; border-radius: 50%; background: var(--text-muted);"></span>
                <span id="llmStatusText">Checking...</span>
              </div>
              <select class="input-field" id="aiModelSelect" style="width: auto; padding: 8px 12px; font-size: 13px;">
                <option value="demo">Demo Mode</option>
              </select>
              <button class="btn-icon" id="refreshModelsBtn" title="Refresh models">
                <i class="fas fa-sync-alt"></i>
              </button>
              <button class="btn-icon" id="clearChatBtn">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
          <div class="ai-chat-messages" id="aiChatMessages">
            <div class="ai-message assistant">
              <div class="markdown-content">
                <p>ðŸ‘‹ Hello! I'm your AI workspace assistant powered by <strong>local LLM</strong>.</p>
                <p>I can connect to:</p>
                <ul>
                  <li><strong>LM Studio</strong> (localhost:1234)</li>
                  <li><strong>Ollama</strong> (localhost:11434)</li>
                </ul>
                <p>Check the status indicator above. If no LLM is detected, start one and click the refresh button.</p>
              </div>
            </div>
          </div>
          <div class="ai-input-area">
            <input type="text" class="input-field" id="aiInput" placeholder="Ask me anything...">
            <button class="btn-primary" id="aiSendBtn">
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Task Modal -->
  <div class="modal-overlay" id="taskModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="taskModalTitle">Add Task</h3>
        <button class="btn-icon" onclick="closeModal('taskModal')">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Task Title</label>
          <input type="text" class="input-field" id="taskTitleInput" placeholder="What needs to be done?">
        </div>
        <div class="form-group">
          <label class="form-label">Due Date</label>
          <input type="date" class="input-field" id="taskDueInput">
        </div>
        <div class="form-group">
          <label class="form-label">Priority</label>
          <div class="priority-options">
            <div class="priority-option selected" data-priority="low">Low</div>
            <div class="priority-option" data-priority="medium">Medium</div>
            <div class="priority-option" data-priority="high">High</div>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Tags (comma-separated)</label>
          <input type="text" class="input-field" id="taskTagsInput" placeholder="work, urgent, project">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeModal('taskModal')">Cancel</button>
        <button class="btn-primary" id="saveTaskBtn">Save Task</button>
      </div>
    </div>
  </div>

  <!-- Note Modal -->
  <div class="modal-overlay" id="noteModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="noteModalTitle">Add Note</h3>
        <button class="btn-icon" onclick="closeModal('noteModal')">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Title</label>
          <input type="text" class="input-field" id="noteTitleInput" placeholder="Note title...">
        </div>
        <div class="form-group">
          <label class="form-label">Content</label>
          <textarea class="input-field" id="noteContentInput" placeholder="Write your note..." rows="6"
            style="resize: vertical;"></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Color</label>
          <div class="color-options">
            <div class="color-option selected" data-color="blue" style="background: #4285f4;"></div>
            <div class="color-option" data-color="yellow" style="background: #fbbc04;"></div>
            <div class="color-option" data-color="green" style="background: #34a853;"></div>
            <div class="color-option" data-color="red" style="background: #ea4335;"></div>
            <div class="color-option" data-color="purple" style="background: #a855f7;"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeModal('noteModal')">Cancel</button>
        <button class="btn-primary" id="saveNoteBtn">Save Note</button>
      </div>
    </div>
  </div>

  <!-- Project Modal -->
  <div class="modal-overlay" id="projectModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">New Project</h3>
        <button class="btn-icon" onclick="closeModal('projectModal')">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Project Name</label>
          <input type="text" class="input-field" id="projectNameInput" placeholder="My Awesome Project">
        </div>
        <div class="form-group">
          <label class="form-label">Description</label>
          <textarea class="input-field" id="projectDescInput" placeholder="What's this project about?"
            rows="3"></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Color</label>
          <div class="color-options">
            <div class="color-option selected" data-color="#4285f4" style="background: #4285f4;"></div>
            <div class="color-option" data-color="#34a853" style="background: #34a853;"></div>
            <div class="color-option" data-color="#fbbc04" style="background: #fbbc04;"></div>
            <div class="color-option" data-color="#ea4335" style="background: #ea4335;"></div>
            <div class="color-option" data-color="#a855f7" style="background: #a855f7;"></div>
            <div class="color-option" data-color="#0ea5e9" style="background: #0ea5e9;"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeModal('projectModal')">Cancel</button>
        <button class="btn-primary" id="saveProjectBtn">Create Project</button>
      </div>
    </div>
  </div>

  <!-- Workspace Modal -->
  <div class="modal-overlay" id="workspaceModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">New Workspace</h3>
        <button class="btn-icon" onclick="closeModal('workspaceModal')">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Workspace Name</label>
          <input type="text" class="input-field" id="workspaceNameInput" placeholder="My Workspace">
        </div>
        <div class="form-group">
          <label class="form-label">Color</label>
          <div class="color-options">
            <div class="color-option selected" data-color="#4285f4" style="background: #4285f4;"></div>
            <div class="color-option" data-color="#34a853" style="background: #34a853;"></div>
            <div class="color-option" data-color="#fbbc04" style="background: #fbbc04;"></div>
            <div class="color-option" data-color="#ea4335" style="background: #ea4335;"></div>
            <div class="color-option" data-color="#a855f7" style="background: #a855f7;"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeModal('workspaceModal')">Cancel</button>
        <button class="btn-primary" id="saveWorkspaceBtn">Create</button>
      </div>
    </div>
  </div>

  <!-- Bookmark Modal -->
  <div class="modal-overlay" id="bookmarkModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Add Bookmark</h3>
        <button class="btn-icon" onclick="closeModal('bookmarkModal')">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Title</label>
          <input type="text" class="input-field" id="bookmarkTitleInput" placeholder="Bookmark name">
        </div>
        <div class="form-group">
          <label class="form-label">URL</label>
          <input type="url" class="input-field" id="bookmarkUrlInput" placeholder="https://...">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeModal('bookmarkModal')">Cancel</button>
        <button class="btn-primary" id="saveBookmarkBtn">Add Bookmark</button>
      </div>
    </div>
  </div>

  <!-- Folder Modal -->
  <div class="modal-overlay" id="folderModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Create Folder</h3>
        <button class="btn-icon" onclick="closeModal('folderModal')">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Folder Name</label>
          <input type="text" class="input-field" id="folderNameInput" placeholder="New Folder">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeModal('folderModal')">Cancel</button>
        <button class="btn-primary" id="createFolderConfirmBtn">Create</button>
      </div>
    </div>
  </div>

  <!-- Layout Item Modal -->
  <div class="modal-overlay" id="layoutItemModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Add Zone</h3>
        <button class="btn-icon" onclick="closeModal('layoutItemModal')">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Zone Label</label>
          <input type="text" class="input-field" id="layoutItemLabel" placeholder="e.g., Work Area, Notes, Browser">
        </div>
        <div class="form-group">
          <label class="form-label">Color</label>
          <div class="color-options">
            <div class="color-option selected" data-color="#4285f4" style="background: #4285f4;"></div>
            <div class="color-option" data-color="#34a853" style="background: #34a853;"></div>
            <div class="color-option" data-color="#fbbc04" style="background: #fbbc04;"></div>
            <div class="color-option" data-color="#ea4335" style="background: #ea4335;"></div>
            <div class="color-option" data-color="#a855f7" style="background: #a855f7;"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeModal('layoutItemModal')">Cancel</button>
        <button class="btn-primary" id="addLayoutItemConfirm">Add Zone</button>
      </div>
    </div>
  </div>

  <!-- Confirm Modal -->
  <div class="modal-overlay" id="confirmModal">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header">
        <h3 class="modal-title" id="confirmTitle">Confirm</h3>
        <button class="btn-icon" onclick="closeModal('confirmModal')">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <p id="confirmMessage">Are you sure?</p>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeModal('confirmModal')">Cancel</button>
        <button class="btn-primary" id="confirmActionBtn" style="background: var(--accent-danger);">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Command Palette -->
  <div class="command-palette-overlay" id="commandPalette">
    <div class="command-palette">
      <input type="text" id="commandInput" placeholder="Type a command...">
      <div class="command-results" id="commandResults"></div>
    </div>
  </div>

  <script>
    // ==================== State Management ====================
    const AppState = {
      currentView: 'dashboard',
      currentWorkspace: 'default',
      tasks: [],
      notes: [],
      projects: [],
      workspaces: [{ id: 'default', name: 'Personal', color: '#4285f4' }],
      files: [],
      bookmarks: [],
      layoutItems: [],
      timerState: {
        time: 1500,
        running: false,
        interval: null
      },
      calendar: {
        month: new Date().getMonth(),
        year: new Date().getFullYear()
      },
      editingTask: null,
      editingNote: null,
      aiMessages: [],
      // LLM Configuration
      llm: {
        provider: null,  // 'lmstudio' | 'ollama' | null
        model: null,
        models: [],
        connected: false
      },
      // Filesystem Configuration
      fs: {
        bridgeConnected: false,
        currentPath: null,
        paths: {},
        realFiles: []
      }
    };

    // ==================== Initialization ====================
    function init() {
      setupTheme();
      loadDemoData();
      setupEventListeners();
      renderAll();
      detectLocalLLM(); // Check for LM Studio / Ollama
    }

    function setupTheme() {
      if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.documentElement.classList.add('dark');
      }
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
        if (event.matches) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
      });
    }

    function loadDemoData() {
      // Demo tasks
      AppState.tasks = [
        { id: '1', title: 'Review project proposal', completed: false, due: getTodayStr(), priority: 'high', tags: ['work', 'urgent'], workspace: 'default' },
        { id: '2', title: 'Update documentation', completed: false, due: getTomorrowStr(), priority: 'medium', tags: ['docs'], workspace: 'default' },
        { id: '3', title: 'Team standup meeting', completed: true, due: getTodayStr(), priority: 'low', tags: ['meeting'], workspace: 'default' }
      ];

      // Demo notes
      AppState.notes = [
        { id: '1', title: 'Meeting Notes', content: 'Discussed Q4 roadmap priorities and resource allocation for the new project.', color: 'blue', workspace: 'default' },
        { id: '2', title: 'Ideas', content: 'Implement dark mode toggle\nAdd keyboard shortcuts\nIntegrate with calendar API', color: 'yellow', workspace: 'default' }
      ];

      // Demo projects
      AppState.projects = [
        { id: '1', name: 'Website Redesign', description: 'Complete overhaul of company website', color: '#4285f4', tasks: 12, completed: 5, workspace: 'default' },
        { id: '2', name: 'Mobile App', description: 'iOS and Android app development', color: '#34a853', tasks: 8, completed: 3, workspace: 'default' }
      ];

      // Demo files
      AppState.files = [
        { id: '1', name: 'Documents', type: 'folder', parent: null },
        { id: '2', name: 'Images', type: 'folder', parent: null },
        { id: '3', name: 'Project Brief.pdf', type: 'document', parent: null },
        { id: '4', name: 'Notes.txt', type: 'document', parent: null }
      ];

      // Demo bookmarks
      AppState.bookmarks = [
        { id: '1', title: 'Google Search', url: 'https://google.com' },
        { id: '2', title: 'GitHub', url: 'https://github.com' }
      ];

      // Demo layout items
      AppState.layoutItems = [
        { id: '1', label: 'Code Editor', color: '#4285f4', x: 20, y: 20, width: 200, height: 150 },
        { id: '2', label: 'Terminal', color: '#34a853', x: 240, y: 20, width: 150, height: 100 }
      ];
    }

    function getTodayStr() {
      return new Date().toISOString().split('T')[0];
    }

    function getTomorrowStr() {
      const d = new Date();
      d.setDate(d.getDate() + 1);
      return d.toISOString().split('T')[0];
    }

    // ==================== Event Listeners ====================
    function setupEventListeners() {
      // Navigation
      document.querySelectorAll('.nav-item[data-view]').forEach(item => {
        item.addEventListener('click', () => switchView(item.dataset.view));
      });

      // Sidebar toggle
      document.getElementById('toggleSidebar').addEventListener('click', toggleSidebar);

      // Theme toggle
      document.getElementById('toggleTheme').addEventListener('click', () => {
        document.documentElement.classList.toggle('dark');
        closeDropdown('settingsDropdown');
      });

      // Settings dropdown
      document.getElementById('settingsDropdown').addEventListener('click', (e) => {
        e.stopPropagation();
        document.getElementById('settingsDropdown').classList.toggle('active');
      });

      document.addEventListener('click', () => {
        closeDropdown('settingsDropdown');
      });

      // Task handlers
      document.getElementById('addTaskBtn').addEventListener('click', () => openTaskModal());
      document.getElementById('saveTaskBtn').addEventListener('click', saveTask);

      // Note handlers
      document.getElementById('addNoteBtn').addEventListener('click', () => openNoteModal());
      document.getElementById('saveNoteBtn').addEventListener('click', saveNote);

      // Project handlers
      document.getElementById('addProjectBtn').addEventListener('click', () => openModal('projectModal'));
      document.getElementById('saveProjectBtn').addEventListener('click', saveProject);

      // Workspace handlers
      document.getElementById('addWorkspaceBtn').addEventListener('click', () => openModal('workspaceModal'));
      document.getElementById('saveWorkspaceBtn').addEventListener('click', saveWorkspace);

      // Bookmark handlers
      document.getElementById('addBookmarkBtn').addEventListener('click', () => openModal('bookmarkModal'));
      document.getElementById('saveBookmarkBtn').addEventListener('click', saveBookmark);

      // File handlers
      document.getElementById('createFolderBtn').addEventListener('click', () => openModal('folderModal'));
      document.getElementById('createFolderConfirmBtn').addEventListener('click', createFolder);
      document.getElementById('uploadFileBtn').addEventListener('click', () => document.getElementById('fileUploadInput').click());
      document.getElementById('fileUploadInput').addEventListener('change', handleFileUpload);

      // Timer handlers
      document.getElementById('timerStartBtn').addEventListener('click', toggleTimer);
      document.getElementById('timerResetBtn').addEventListener('click', resetTimer);
      document.querySelectorAll('.timer-type-btn').forEach(btn => {
        btn.addEventListener('click', () => setTimerType(btn));
      });

      // Calendar handlers
      document.getElementById('prevMonth').addEventListener('click', () => navigateCalendar(-1));
      document.getElementById('nextMonth').addEventListener('click', () => navigateCalendar(1));

      // Layout handlers
      document.getElementById('addLayoutItem').addEventListener('click', () => openModal('layoutItemModal'));
      document.getElementById('addLayoutItemConfirm').addEventListener('click', addLayoutItem);
      document.getElementById('clearCanvas').addEventListener('click', clearLayoutCanvas);
      document.getElementById('saveLayout').addEventListener('click', () => showToast('Layout saved!', 'success'));

      // AI handlers
      document.getElementById('aiSendBtn').addEventListener('click', sendAIMessage);
      document.getElementById('aiInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendAIMessage();
      });
      document.getElementById('clearChatBtn').addEventListener('click', clearAIChat);
      document.getElementById('refreshModelsBtn').addEventListener('click', detectLocalLLM);

      // Filesystem handlers
      document.getElementById('goDesktop').addEventListener('click', () => loadDirectory(AppState.fs.paths.desktop || ''));
      document.getElementById('goDocuments').addEventListener('click', () => loadDirectory(AppState.fs.paths.documents || ''));
      document.getElementById('goDownloads').addEventListener('click', () => loadDirectory(AppState.fs.paths.downloads || ''));
      document.getElementById('goUp').addEventListener('click', goUpDirectory);
      document.getElementById('refreshFiles').addEventListener('click', () => {
        if (AppState.fs.currentPath) loadDirectory(AppState.fs.currentPath);
        else checkFilesystemBridge();
      });

      // Export/Import handlers
      document.getElementById('exportBtn').addEventListener('click', exportData);
      document.getElementById('importBtn').addEventListener('click', () => {
        document.getElementById('importInput').click();
        closeDropdown('settingsDropdown');
      });
      document.getElementById('importInput').addEventListener('change', importData);

      // Reset handler
      document.getElementById('resetBtn').addEventListener('click', () => {
        showConfirm('Reset All Data', 'This will delete all your data. This cannot be undone.', () => {
          loadDemoData();
          renderAll();
          showToast('Data reset to defaults', 'info');
        });
        closeDropdown('settingsDropdown');
      });

      // Priority options
      document.querySelectorAll('.priority-option').forEach(opt => {
        opt.addEventListener('click', () => {
          document.querySelectorAll('.priority-option').forEach(o => o.classList.remove('selected'));
          opt.classList.add('selected');
        });
      });

      // Color options
      document.querySelectorAll('.color-options').forEach(container => {
        container.querySelectorAll('.color-option').forEach(opt => {
          opt.addEventListener('click', () => {
            container.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
            opt.classList.add('selected');
          });
        });
      });

      // Global search
      document.getElementById('globalSearch').addEventListener('input', handleGlobalSearch);
    }

    // ==================== View Management ====================
    function switchView(view) {
      AppState.currentView = view;
      document.querySelectorAll('.nav-item[data-view]').forEach(item => {
        item.classList.toggle('active', item.dataset.view === view);
      });

      document.getElementById('dashboardView').style.display = view === 'dashboard' ? '' : 'none';
      document.getElementById('filesView').style.display = view === 'files' ? '' : 'none';
      document.getElementById('canvasView').style.display = view === 'canvas' ? '' : 'none';
      document.getElementById('aiView').style.display = view === 'ai' ? '' : 'none';

      if (view === 'canvas') {
        renderLayoutCanvas();
      }

      if (view === 'files') {
        // Check bridge and load Desktop by default
        checkFilesystemBridge().then(connected => {
          if (connected && !AppState.fs.currentPath) {
            loadDirectory(AppState.fs.paths.desktop);
          }
        });
      }
    }

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
    }

    // ==================== Modal Management ====================
    function openModal(modalId) {
      document.getElementById(modalId).classList.add('active');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    function openTaskModal(task = null) {
      AppState.editingTask = task;
      document.getElementById('taskModalTitle').textContent = task ? 'Edit Task' : 'Add Task';
      document.getElementById('taskTitleInput').value = task?.title || '';
      document.getElementById('taskDueInput').value = task?.due || '';
      document.getElementById('taskTagsInput').value = task?.tags?.join(', ') || '';

      document.querySelectorAll('.priority-option').forEach(opt => {
        opt.classList.toggle('selected', opt.dataset.priority === (task?.priority || 'low'));
      });

      openModal('taskModal');
    }

    function openNoteModal(note = null) {
      AppState.editingNote = note;
      document.getElementById('noteModalTitle').textContent = note ? 'Edit Note' : 'Add Note';
      document.getElementById('noteTitleInput').value = note?.title || '';
      document.getElementById('noteContentInput').value = note?.content || '';

      const colorOptions = document.querySelector('#noteModal .color-options');
      colorOptions.querySelectorAll('.color-option').forEach(opt => {
        opt.classList.toggle('selected', opt.dataset.color === (note?.color || 'blue'));
      });

      openModal('noteModal');
    }

    function showConfirm(title, message, onConfirm) {
      document.getElementById('confirmTitle').textContent = title;
      document.getElementById('confirmMessage').textContent = message;
      document.getElementById('confirmActionBtn').onclick = () => {
        onConfirm();
        closeModal('confirmModal');
      };
      openModal('confirmModal');
    }

    // ==================== Rendering Functions ====================
    function renderAll() {
      renderTasks();
      renderNotes();
      renderProjects();
      renderWorkspaces();
      renderFiles();
      renderBookmarks();
      renderCalendar();
    }

    function renderTasks() {
      const container = document.getElementById('taskList');
      const tasks = AppState.tasks.filter(t => t.workspace === AppState.currentWorkspace);

      if (tasks.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-check-circle"></i>
            <p>No tasks yet. Add one to get started!</p>
          </div>
        `;
        return;
      }

      container.innerHTML = tasks.map(task => `
        <div class="task-item" data-id="${task.id}">
          <div class="task-checkbox ${task.completed ? 'checked' : ''}" onclick="toggleTask('${task.id}')">
            ${task.completed ? '<i class="fas fa-check"></i>' : ''}
          </div>
          <div class="task-content" onclick="openTaskModal(AppState.tasks.find(t => t.id === '${task.id}'))">
            <div class="task-text ${task.completed ? 'completed' : ''}">${escapeHtml(task.title)}</div>
            <div class="task-meta">
              ${task.due ? `<span class="tag tag-blue"><i class="fas fa-calendar"></i> ${formatDate(task.due)}</span>` : ''}
              <span class="tag tag-${getPriorityColor(task.priority)}">${task.priority}</span>
              ${task.tags?.map(tag => `<span class="tag tag-purple">${escapeHtml(tag)}</span>`).join('') || ''}
            </div>
          </div>
          <button class="btn-icon" onclick="deleteTask('${task.id}')">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      `).join('');

      // Initialize sortable
      if (typeof Sortable !== 'undefined') {
        new Sortable(container, {
          animation: 150,
          ghostClass: 'sortable-ghost',
          chosenClass: 'sortable-chosen'
        });
      }
    }

    function renderNotes() {
      const container = document.getElementById('notesList');
      const notes = AppState.notes.filter(n => n.workspace === AppState.currentWorkspace);

      if (notes.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-sticky-note"></i>
            <p>No notes yet. Create one!</p>
          </div>
        `;
        return;
      }

      container.innerHTML = notes.map(note => `
        <div class="note-card ${note.color}" onclick="openNoteModal(AppState.notes.find(n => n.id === '${note.id}'))">
          <div class="note-title">${escapeHtml(note.title)}</div>
          <div class="note-preview">${escapeHtml(note.content)}</div>
        </div>
      `).join('');
    }

    function renderProjects() {
      const container = document.getElementById('projectsList');
      const projects = AppState.projects.filter(p => p.workspace === AppState.currentWorkspace);

      if (projects.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-project-diagram"></i>
            <p>No projects yet. Create one!</p>
          </div>
        `;
        return;
      }

      container.innerHTML = projects.map(project => `
        <div class="project-card">
          <div class="project-header">
            <div class="project-color" style="background: ${project.color}"></div>
            <div class="project-name">${escapeHtml(project.name)}</div>
          </div>
          <div class="project-stats">
            <span><i class="fas fa-tasks"></i> ${project.completed}/${project.tasks} tasks</span>
            <span><i class="fas fa-percentage"></i> ${Math.round((project.completed / project.tasks) * 100) || 0}%</span>
          </div>
        </div>
      `).join('');
    }

    function renderWorkspaces() {
      const container = document.getElementById('workspaceList');
      container.innerHTML = AppState.workspaces.map(ws => `
        <div class="workspace-item ${ws.id === AppState.currentWorkspace ? 'active' : ''}"
             onclick="switchWorkspace('${ws.id}')">
          <div class="workspace-dot" style="background: ${ws.color}"></div>
          <span>${escapeHtml(ws.name)}</span>
        </div>
      `).join('');
    }

    function renderFiles() {
      const container = document.getElementById('fileGrid');

      if (AppState.files.length === 0) {
        container.innerHTML = `
          <div class="empty-state" style="grid-column: 1 / -1;">
            <i class="fas fa-folder-open"></i>
            <p>No files yet. Upload or create a folder!</p>
          </div>
        `;
        return;
      }

      container.innerHTML = AppState.files.map(file => `
        <div class="file-item" data-id="${file.id}">
          <div class="file-icon ${file.type}">
            <i class="fas fa-${getFileIcon(file.type)}"></i>
          </div>
          <div class="file-name">${escapeHtml(file.name)}</div>
        </div>
      `).join('');
    }

    function renderBookmarks() {
      const container = document.getElementById('bookmarksList');

      if (AppState.bookmarks.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-bookmark"></i>
            <p>No bookmarks yet. Add one!</p>
          </div>
        `;
        return;
      }

      container.innerHTML = AppState.bookmarks.map(bookmark => `
        <a class="quick-link" href="${escapeHtml(bookmark.url)}" target="_blank" rel="noopener">
          <div class="quick-link-icon" style="background: var(--bg-tertiary);">
            <i class="fas fa-link"></i>
          </div>
          <span style="font-size: 14px;">${escapeHtml(bookmark.title)}</span>
        </a>
      `).join('');
    }

    function renderCalendar() {
      const { month, year } = AppState.calendar;
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'];

      document.getElementById('calendarMonthYear').textContent = `${monthNames[month]} ${year}`;

      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const today = new Date();

      let html = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']
        .map(d => `<div class="calendar-header">${d}</div>`).join('');

      // Empty cells before first day
      for (let i = 0; i < firstDay; i++) {
        html += '<div class="calendar-day"></div>';
      }

      // Days of month
      for (let day = 1; day <= daysInMonth; day++) {
        const isToday = day === today.getDate() && month === today.getMonth() && year === today.getFullYear();
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const hasEvent = AppState.tasks.some(t => t.due === dateStr && !t.completed);

        html += `<div class="calendar-day ${isToday ? 'today' : ''} ${hasEvent ? 'has-event' : ''}">${day}</div>`;
      }

      document.getElementById('calendarGrid').innerHTML = html;
    }

    function renderLayoutCanvas() {
      const canvas = document.getElementById('layoutCanvas');
      const existingItems = canvas.querySelectorAll('.layout-item');
      existingItems.forEach(item => item.remove());

      AppState.layoutItems.forEach(item => {
        const el = document.createElement('div');
        el.className = 'layout-item';
        el.dataset.id = item.id;
        el.style.cssText = `left: ${item.x}px; top: ${item.y}px; width: ${item.width}px; height: ${item.height}px; border-color: ${item.color};`;
        el.innerHTML = `<span style="color: ${item.color}">${escapeHtml(item.label)}</span>`;

        makeDraggable(el);
        makeResizable(el);

        canvas.appendChild(el);
      });
    }

    // ==================== Data Operations ====================
    function saveTask() {
      const title = document.getElementById('taskTitleInput').value.trim();
      if (!title) {
        showToast('Please enter a task title', 'error');
        return;
      }

      const priority = document.querySelector('.priority-option.selected').dataset.priority;
      const due = document.getElementById('taskDueInput').value;
      const tagsInput = document.getElementById('taskTagsInput').value;
      const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];

      if (AppState.editingTask) {
        const task = AppState.tasks.find(t => t.id === AppState.editingTask.id);
        if (task) {
          task.title = title;
          task.priority = priority;
          task.due = due;
          task.tags = tags;
        }
        showToast('Task updated', 'success');
      } else {
        AppState.tasks.push({
          id: Date.now().toString(),
          title,
          completed: false,
          due,
          priority,
          tags,
          workspace: AppState.currentWorkspace
        });
        showToast('Task added', 'success');
      }

      closeModal('taskModal');
      renderTasks();
      renderCalendar();
    }

    function toggleTask(id) {
      const task = AppState.tasks.find(t => t.id === id);
      if (task) {
        task.completed = !task.completed;
        renderTasks();
      }
    }

    function deleteTask(id) {
      showConfirm('Delete Task', 'Are you sure you want to delete this task?', () => {
        AppState.tasks = AppState.tasks.filter(t => t.id !== id);
        renderTasks();
        showToast('Task deleted', 'info');
      });
    }

    function saveNote() {
      const title = document.getElementById('noteTitleInput').value.trim();
      const content = document.getElementById('noteContentInput').value.trim();

      if (!title) {
        showToast('Please enter a note title', 'error');
        return;
      }

      const color = document.querySelector('#noteModal .color-option.selected').dataset.color;

      if (AppState.editingNote) {
        const note = AppState.notes.find(n => n.id === AppState.editingNote.id);
        if (note) {
          note.title = title;
          note.content = content;
          note.color = color;
        }
        showToast('Note updated', 'success');
      } else {
        AppState.notes.push({
          id: Date.now().toString(),
          title,
          content,
          color,
          workspace: AppState.currentWorkspace
        });
        showToast('Note created', 'success');
      }

      closeModal('noteModal');
      renderNotes();
    }

    function saveProject() {
      const name = document.getElementById('projectNameInput').value.trim();
      if (!name) {
        showToast('Please enter a project name', 'error');
        return;
      }

      const description = document.getElementById('projectDescInput').value.trim();
      const color = document.querySelector('#projectModal .color-option.selected').dataset.color;

      AppState.projects.push({
        id: Date.now().toString(),
        name,
        description,
        color,
        tasks: 0,
        completed: 0,
        workspace: AppState.currentWorkspace
      });

      closeModal('projectModal');
      document.getElementById('projectNameInput').value = '';
      document.getElementById('projectDescInput').value = '';
      renderProjects();
      showToast('Project created', 'success');
    }

    function saveWorkspace() {
      const name = document.getElementById('workspaceNameInput').value.trim();
      if (!name) {
        showToast('Please enter a workspace name', 'error');
        return;
      }

      const color = document.querySelector('#workspaceModal .color-option.selected').dataset.color;
      const id = Date.now().toString();

      AppState.workspaces.push({ id, name, color });
      closeModal('workspaceModal');
      document.getElementById('workspaceNameInput').value = '';
      renderWorkspaces();
      showToast('Workspace created', 'success');
    }

    function switchWorkspace(id) {
      AppState.currentWorkspace = id;
      renderAll();
    }

    function saveBookmark() {
      const title = document.getElementById('bookmarkTitleInput').value.trim();
      const url = document.getElementById('bookmarkUrlInput').value.trim();

      if (!title || !url) {
        showToast('Please fill in all fields', 'error');
        return;
      }

      AppState.bookmarks.push({
        id: Date.now().toString(),
        title,
        url
      });

      closeModal('bookmarkModal');
      document.getElementById('bookmarkTitleInput').value = '';
      document.getElementById('bookmarkUrlInput').value = '';
      renderBookmarks();
      showToast('Bookmark added', 'success');
    }

    function createFolder() {
      const name = document.getElementById('folderNameInput').value.trim();
      if (!name) {
        showToast('Please enter a folder name', 'error');
        return;
      }

      AppState.files.push({
        id: Date.now().toString(),
        name,
        type: 'folder',
        parent: null
      });

      closeModal('folderModal');
      document.getElementById('folderNameInput').value = '';
      renderFiles();
      showToast('Folder created', 'success');
    }

    function handleFileUpload(e) {
      const files = e.target.files;
      if (!files.length) return;

      Array.from(files).forEach(file => {
        const type = getFileType(file.name);
        AppState.files.push({
          id: Date.now().toString() + Math.random(),
          name: file.name,
          type,
          parent: null,
          size: file.size
        });
      });

      renderFiles();
      showToast(`${files.length} file(s) added`, 'success');
      e.target.value = '';
    }

    // ==================== Timer Functions ====================
    function toggleTimer() {
      const btn = document.getElementById('timerStartBtn');

      if (AppState.timerState.running) {
        clearInterval(AppState.timerState.interval);
        AppState.timerState.running = false;
        btn.innerHTML = '<i class="fas fa-play"></i> Start';
      } else {
        AppState.timerState.running = true;
        btn.innerHTML = '<i class="fas fa-pause"></i> Pause';

        AppState.timerState.interval = setInterval(() => {
          AppState.timerState.time--;
          updateTimerDisplay();

          if (AppState.timerState.time <= 0) {
            clearInterval(AppState.timerState.interval);
            AppState.timerState.running = false;
            btn.innerHTML = '<i class="fas fa-play"></i> Start';
            showToast('Timer complete! Take a break.', 'success');
          }
        }, 1000);
      }
    }

    function resetTimer() {
      clearInterval(AppState.timerState.interval);
      AppState.timerState.running = false;
      document.getElementById('timerStartBtn').innerHTML = '<i class="fas fa-play"></i> Start';

      const activeBtn = document.querySelector('.timer-type-btn.active');
      AppState.timerState.time = parseInt(activeBtn.dataset.time);
      updateTimerDisplay();
    }

    function setTimerType(btn) {
      document.querySelectorAll('.timer-type-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      clearInterval(AppState.timerState.interval);
      AppState.timerState.running = false;
      document.getElementById('timerStartBtn').innerHTML = '<i class="fas fa-play"></i> Start';

      AppState.timerState.time = parseInt(btn.dataset.time);
      updateTimerDisplay();
    }

    function updateTimerDisplay() {
      const minutes = Math.floor(AppState.timerState.time / 60);
      const seconds = AppState.timerState.time % 60;
      document.getElementById('timerDisplay').textContent =
        `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }

    // ==================== Calendar Functions ====================
    function navigateCalendar(direction) {
      AppState.calendar.month += direction;

      if (AppState.calendar.month > 11) {
        AppState.calendar.month = 0;
        AppState.calendar.year++;
      } else if (AppState.calendar.month < 0) {
        AppState.calendar.month = 11;
        AppState.calendar.year--;
      }

      renderCalendar();
    }

    // ==================== Layout Canvas Functions ====================
    function addLayoutItem() {
      const label = document.getElementById('layoutItemLabel').value.trim();
      if (!label) {
        showToast('Please enter a zone label', 'error');
        return;
      }

      const color = document.querySelector('#layoutItemModal .color-option.selected').dataset.color;

      AppState.layoutItems.push({
        id: Date.now().toString(),
        label,
        color,
        x: 50 + Math.random() * 100,
        y: 50 + Math.random() * 100,
        width: 150,
        height: 100
      });

      closeModal('layoutItemModal');
      document.getElementById('layoutItemLabel').value = '';
      renderLayoutCanvas();
      showToast('Zone added', 'success');
    }

    function clearLayoutCanvas() {
      showConfirm('Clear Canvas', 'This will remove all layout zones.', () => {
        AppState.layoutItems = [];
        renderLayoutCanvas();
        showToast('Canvas cleared', 'info');
      });
    }

    function makeDraggable(el) {
      let isDragging = false;
      let startX, startY, origX, origY;

      el.addEventListener('mousedown', (e) => {
        if (e.target.classList.contains('resize-handle')) return;
        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
        origX = el.offsetLeft;
        origY = el.offsetTop;
        el.classList.add('selected');
      });

      document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        el.style.left = (origX + dx) + 'px';
        el.style.top = (origY + dy) + 'px';
      });

      document.addEventListener('mouseup', () => {
        if (isDragging) {
          isDragging = false;
          el.classList.remove('selected');
          updateLayoutItemPosition(el);
        }
      });
    }

    function makeResizable(el) {
      const handle = document.createElement('div');
      handle.className = 'resize-handle';
      handle.style.cssText = 'position: absolute; bottom: 0; right: 0; width: 15px; height: 15px; cursor: se-resize;';
      el.appendChild(handle);

      let isResizing = false;
      let startX, startY, startWidth, startHeight;

      handle.addEventListener('mousedown', (e) => {
        e.stopPropagation();
        isResizing = true;
        startX = e.clientX;
        startY = e.clientY;
        startWidth = el.offsetWidth;
        startHeight = el.offsetHeight;
      });

      document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;
        const width = startWidth + (e.clientX - startX);
        const height = startHeight + (e.clientY - startY);
        el.style.width = Math.max(50, width) + 'px';
        el.style.height = Math.max(50, height) + 'px';
      });

      document.addEventListener('mouseup', () => {
        if (isResizing) {
          isResizing = false;
          updateLayoutItemPosition(el);
        }
      });
    }

    function updateLayoutItemPosition(el) {
      const id = el.dataset.id;
      const item = AppState.layoutItems.find(i => i.id === id);
      if (item) {
        item.x = el.offsetLeft;
        item.y = el.offsetTop;
        item.width = el.offsetWidth;
        item.height = el.offsetHeight;
      }
    }

    // ==================== Local LLM Functions ====================
    async function detectLocalLLM() {
      const statusDot = document.getElementById('llmStatusDot');
      const statusText = document.getElementById('llmStatusText');
      const modelSelect = document.getElementById('aiModelSelect');

      statusDot.style.background = 'var(--accent-warning)';
      statusText.textContent = 'Checking...';

      // Try LM Studio first (localhost:1234)
      try {
        const lmRes = await fetch('http://localhost:1234/v1/models', {
          signal: AbortSignal.timeout(3000)
        });
        if (lmRes.ok) {
          const data = await lmRes.json();
          const models = data.data?.map(m => m.id) || [];
          if (models.length > 0) {
            AppState.llm.provider = 'lmstudio';
            AppState.llm.models = models;
            AppState.llm.model = models[0];
            AppState.llm.connected = true;

            statusDot.style.background = 'var(--accent-secondary)';
            statusText.textContent = 'LM Studio';

            modelSelect.innerHTML = models.map(m =>
              `<option value="${m}">${m.split('/').pop()}</option>`
            ).join('');

            showToast('Connected to LM Studio', 'success');
            return;
          }
        }
      } catch (e) {
        console.log('LM Studio not available');
      }

      // Try Ollama (localhost:11434)
      try {
        const ollamaRes = await fetch('http://localhost:11434/api/tags', {
          signal: AbortSignal.timeout(3000)
        });
        if (ollamaRes.ok) {
          const data = await ollamaRes.json();
          const models = data.models?.map(m => m.name) || [];
          if (models.length > 0) {
            AppState.llm.provider = 'ollama';
            AppState.llm.models = models;
            AppState.llm.model = models[0];
            AppState.llm.connected = true;

            statusDot.style.background = 'var(--accent-secondary)';
            statusText.textContent = 'Ollama';

            modelSelect.innerHTML = models.map(m =>
              `<option value="${m}">${m}</option>`
            ).join('');

            showToast('Connected to Ollama', 'success');
            return;
          }
        }
      } catch (e) {
        console.log('Ollama not available');
      }

      // No local LLM found
      AppState.llm.provider = null;
      AppState.llm.connected = false;
      statusDot.style.background = 'var(--text-muted)';
      statusText.textContent = 'No local LLM';
      modelSelect.innerHTML = '<option value="demo">Demo Mode</option>';
    }

    async function sendToLocalLLM(message) {
      if (!AppState.llm.connected) {
        throw new Error('No local LLM connected');
      }

      const model = document.getElementById('aiModelSelect').value;

      if (AppState.llm.provider === 'lmstudio') {
        const response = await fetch('http://localhost:1234/v1/chat/completions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: model,
            messages: [
              { role: 'system', content: 'You are a helpful workspace assistant. Be concise and helpful.' },
              { role: 'user', content: message }
            ],
            max_tokens: 2048,
            stream: false
          })
        });

        if (!response.ok) throw new Error('LM Studio request failed');
        const data = await response.json();
        return data.choices?.[0]?.message?.content || 'No response';
      }

      if (AppState.llm.provider === 'ollama') {
        const response = await fetch('http://localhost:11434/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: model,
            messages: [
              { role: 'system', content: 'You are a helpful workspace assistant. Be concise and helpful.' },
              { role: 'user', content: message }
            ],
            stream: false
          })
        });

        if (!response.ok) throw new Error('Ollama request failed');
        const data = await response.json();
        return data.message?.content || 'No response';
      }

      throw new Error('Unknown LLM provider');
    }

    // ==================== Filesystem Bridge Functions ====================
    const BRIDGE_URL = 'http://localhost:3456';

    async function checkFilesystemBridge() {
      const statusEl = document.getElementById('bridgeStatus');
      const statusText = document.getElementById('bridgeStatusText');

      try {
        const res = await fetch(`${BRIDGE_URL}/status`, { signal: AbortSignal.timeout(2000) });
        if (res.ok) {
          const data = await res.json();
          AppState.fs.bridgeConnected = true;
          AppState.fs.paths = data.paths;
          statusEl.style.display = 'none';
          return true;
        }
      } catch (e) {
        console.log('Bridge not available');
      }

      AppState.fs.bridgeConnected = false;
      statusEl.style.display = 'block';
      statusEl.style.background = 'rgba(234,67,53,0.1)';
      statusText.innerHTML = 'Bridge not running. Start with: <code>node bridge.js</code>';
      return false;
    }

    async function loadDirectory(dirPath) {
      if (!AppState.fs.bridgeConnected) {
        await checkFilesystemBridge();
        if (!AppState.fs.bridgeConnected) return;
      }

      try {
        const res = await fetch(`${BRIDGE_URL}/list?path=${encodeURIComponent(dirPath)}`);
        if (res.ok) {
          const data = await res.json();
          AppState.fs.currentPath = data.path;
          AppState.fs.realFiles = data.files;
          renderRealFiles();

          // Update path display
          const pathParts = data.path.split(/[\/\\]/);
          document.getElementById('currentPath').textContent = pathParts.slice(-2).join('/');
        }
      } catch (e) {
        showToast('Failed to load directory', 'error');
      }
    }

    function renderRealFiles() {
      const container = document.getElementById('fileGrid');
      const files = AppState.fs.realFiles;

      if (files.length === 0) {
        container.innerHTML = `
          <div class="empty-state" style="grid-column: 1 / -1;">
            <i class="fas fa-folder-open"></i>
            <p>This folder is empty</p>
          </div>
        `;
        return;
      }

      container.innerHTML = files.map(file => `
        <div class="file-item" data-path="${escapeHtml(file.path)}" data-isdir="${file.isDirectory}" onclick="handleFileClick(this)">
          <div class="file-icon ${file.type}">
            <i class="fas fa-${getFileIcon(file.type)}"></i>
          </div>
          <div class="file-name">${escapeHtml(file.name)}</div>
        </div>
      `).join('');
    }

    function handleFileClick(el) {
      const filePath = el.dataset.path;
      const isDir = el.dataset.isdir === 'true';

      if (isDir) {
        loadDirectory(filePath);
      } else {
        openFile(filePath);
      }
    }

    async function openFile(filePath) {
      try {
        await fetch(`${BRIDGE_URL}/open?path=${encodeURIComponent(filePath)}`);
      } catch (e) {
        showToast('Failed to open file', 'error');
      }
    }

    function goUpDirectory() {
      if (!AppState.fs.currentPath) return;
      const parentPath = AppState.fs.currentPath.split(/[\/\\]/).slice(0, -1).join('\\');
      if (parentPath) loadDirectory(parentPath);
    }

    // ==================== AI Chat Functions ====================
    // NOTE: AI chat functions have been moved to main.js to support modular imports.
    // This section is now empty.

    // ==================== Export/Import Functions ====================
    function exportData() {
      const data = {
        version: 1,
        exportedAt: new Date().toISOString(),
        tasks: AppState.tasks,
        notes: AppState.notes,
        projects: AppState.projects,
        workspaces: AppState.workspaces,
        files: AppState.files,
        bookmarks: AppState.bookmarks,
        layoutItems: AppState.layoutItems
      };

      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `nexus-workspace-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);

      showToast('Data exported successfully', 'success');
    }

    function importData(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const data = JSON.parse(event.target.result);

          if (data.tasks) AppState.tasks = data.tasks;
          if (data.notes) AppState.notes = data.notes;
          if (data.projects) AppState.projects = data.projects;
          if (data.workspaces) AppState.workspaces = data.workspaces;
          if (data.files) AppState.files = data.files;
          if (data.bookmarks) AppState.bookmarks = data.bookmarks;
          if (data.layoutItems) AppState.layoutItems = data.layoutItems;

          renderAll();
          showToast('Data imported successfully', 'success');
        } catch (err) {
          showToast('Failed to import data. Invalid file format.', 'error');
        }
      };
      reader.readAsText(file);
      e.target.value = '';
    }

    // ==================== Search Function ====================
    function handleGlobalSearch(e) {
      const query = e.target.value.toLowerCase();
      if (!query) {
        renderAll();
        return;
      }

      // Filter tasks
      const filteredTasks = AppState.tasks.filter(t =>
        t.title.toLowerCase().includes(query) ||
        t.tags?.some(tag => tag.toLowerCase().includes(query))
      );

      // Render filtered results (simplified)
      const taskContainer = document.getElementById('taskList');
      if (filteredTasks.length === 0) {
        taskContainer.innerHTML = `<div class="empty-state"><i class="fas fa-search"></i><p>No matching tasks found</p></div>`;
      } else {
        const originalTasks = AppState.tasks;
        AppState.tasks = filteredTasks;
        renderTasks();
        AppState.tasks = originalTasks;
      }
    }

    // ==================== Utility Functions ====================
    function escapeHtml(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    function getPriorityColor(priority) {
      const colors = { low: 'green', medium: 'yellow', high: 'red' };
      return colors[priority] || 'blue';
    }

    function getFileIcon(type) {
      const icons = {
        folder: 'folder',
        image: 'image',
        document: 'file-alt',
        code: 'code',
        other: 'file'
      };
      return icons[type] || 'file';
    }

    function getFileType(filename) {
      const ext = filename.split('.').pop().toLowerCase();
      const imageExts = ['jpg', 'jpeg', 'png', 'gif', 'svg', 'webp'];
      const codeExts = ['js', 'ts', 'py', 'html', 'css', 'json'];
      const docExts = ['pdf', 'doc', 'docx', 'txt', 'md'];

      if (imageExts.includes(ext)) return 'image';
      if (codeExts.includes(ext)) return 'code';
      if (docExts.includes(ext)) return 'document';
      return 'other';
    }

    function closeDropdown(id) {
      document.getElementById(id).classList.remove('active');
    }

    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
        <span>${escapeHtml(message)}</span>
      `;
      container.appendChild(toast);

      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Initialize app
    init();
  </script>
</body>

</html>